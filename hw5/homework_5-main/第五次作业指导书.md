# 面向对象设计与构造第五次作业指导书

## 第一部分：训练目标

本次作业的目标是模拟**多线程实时电梯系统**，熟悉线程的创建、运行等基本操作，熟悉多线程程序的设计方法。

------

## 第二部分：题目概况

我们要模拟的电梯系统是一个类似北京航空航天大学新主楼的电梯系统，楼座内有**多部电梯**，电梯可以在楼座内1-11层之间运行。系统从标准输入中读入乘客请求信息(起点层，终点楼层)，**请求调度器**会根据此时电梯运行情况(电梯所在楼层，运行方向等)将乘客请求合理**分配给某部电梯**，然后被分配请求的电梯会经过**上下行，开关门，乘客进入/离开电梯**等动作将乘客从起点层运送到终点层。请求的输入通过**我们提供的**输入接口来**定时投放**请求，你需要调用我们提供的接口，接口具体细节参考**第三部分和相关文档**。

可以采用**任何电梯运行策略**，即任意时刻，系统选择上下行动，是否在某层开关门都可以自定义，只要保证在**电梯系统运行时间不超过题目要求时间上限**的前提下将所有的乘客送至目的地即可。

------

## 第三部分：输入/输出接口

### 一、输入输出接口说明

- $1、$本单元作业**请使用官方提供的输入输出接口进行输入输出（见本次作业公开仓库）**。
- $2、$输入接口提供了若干方法，通过调用方法可以直接获取所需数据对象。输入接口在**尝试**读取标准输入的内容时，对于正确的输入将成功解析，错误的则输出错误信息，但不会影响程序的正常运行。
- $3、$输出子程序接受一个字符串，并附上时间戳后再输出。
- $4、$**详细的接口定义和使用方法见官方接口说明文档。**
- $5、$程序的输入输出为**实时交互**，评测机可以做到在某个时间点投放一定量的输入。
- $6、$**不需要考虑由于调用输入输出接口导致的时间上的差异**，可以认为**准时**投放请求和输出相关内容。
- $7、$**不需要对输入输出接口进行修改**。

------

## 第四部分：电梯运行

### 一、功能描述


完成乘客请求，即对于每个乘客请求(起点层，终点层)，需要调度电梯将其完成，并将必要的运行信息通过输出接口进行输出。具体而言，你需要控制电梯**上下行，开关门的动作**以及**控制乘客进出电梯**来将乘客从起点层运送到终点层。我们的电梯系统**有多部电梯**，你需要合理的调度这些电梯来达到更好的性能（**第一次作业**指定了接送乘客的电梯）。


### 二、输入输出格式

#### 1.输入格式

- 每个乘客由**指定的**电梯从起点层接送到终点层。格式为：`[时间戳]乘客ID-FROM-起点层-TO-终点层-BY-电梯ID`。

#### 2.输出格式

- 通过调用输出接口的每一次输出将自动附加时间戳于头部，具体请参考**输出接口文档**，请不要试图伪造时间戳，否则会在实际评测时产生不一样的结果导致程序运行错误。
- 电梯到达某一位置：`[时间戳]ARRIVE-所在层-电梯ID`
- 电梯开门：`[时间戳]OPEN-所在层-电梯ID`
- 电梯关门：`[时间戳]CLOSE-所在层-电梯ID`
- 乘客进入电梯：`[时间戳]IN-乘客ID-所在层-电梯ID`
- 乘客离开电梯：`[时间戳]OUT-乘客ID-所在层-电梯ID`

### 三、正确性说明

#### 电梯运行基本约束

* 电梯系统**默认初始在1层有6部电梯**，电梯默认性能参数如下：

  >* 可到达楼层：1-11层
  >* 初始位置：1层
  >* 数量：6部
  >* 编号：6部电梯，ID分别为1-6
  >* 移动一层花费的时间：0.4s
  >* 开门花费的时间：0.2s
  >* 关门花费的时间：0.2s
  >* 限乘人数：6人

* 电梯在两层楼之间移动应满足移动时间要求，且电梯只能在大楼的楼层范围内移动，电梯移动时必须关门。

* 电梯默认初始时为关门状态，电梯只有开门才可以关门，只有关门才可以开门。

* 乘客默认不在电梯里，只有进入电梯才可以出电梯，只有不在电梯里才可以进电梯，且乘客只能进入同层的电梯。

* 乘客**能且只能**在电梯开门和关门的窗口期内进出电梯，但乘客进出电梯**不需要时间**(~~纸片人没有厚度~~)。

* **运行时的任意时刻需满足轿厢容量限制以及输出时间戳非减限制，系统结束时不可以有乘客请求未完成或乘客困在电梯里的情况出现**。（<font color = red>此规定作用于所有作业的任何功能模块，对任何输出有效，以后不再赘述！</font>）

* 本次作业必须由**指定的**电梯接送乘客，完成请求！！！即乘客**只能进入和离开**输入时指定的电梯，不可以进入其他电梯。

### 四、实现提示

- $1、$电梯的"运行策略"实际上可以抽象为从一组待选任务当中选取一个来执行。可以先编写一个**候乘表类**来显示当前电梯系统中各层等待电梯服务的乘客。再编写一个**策略类**，接受这个候乘表类，分析并返回一个目标动作（开关门、上下行等）。因此，分析的过程被隐藏在了策略类内部。

- $2、$将策略类实例对象作为电梯的一个属性，通过更换策略类，就可以灵活地切换执行策略。或应用工厂模式组装不同电梯。

- $3、$电梯的运行流程可以抽象为：到达一层→开门→乘客进出→关门→寻找下一目标层→移动，可以使用状态模式建模。
![电梯运行逻辑](http://api.oo.buaa.edu.cn/image/2024_03_22_12_36_14_abd2e2e4c2d1c4031cceb2800020e824587cfde2)


  在**不违反课程规则**的前提下，我们对电梯的**捎带策略不做限制**。鼓励同学们多多阅读并自行探索相关算法，对电梯的捎带策略有自己的设计与思考。为保证同学们实现的都为作业要求的**可捎带电梯**，我们对电梯的性能做一定的约束，采用**ALS调度策略**为性能**基准**（关于调度策略，欢迎大家积极上网找资料探索）。

对于每一个电梯，都采用 ALS 策略，即新增**主请求**和**被捎带请求**两个概念

- $1、$主请求选择规则：

  - $(1)、$如果电梯中没有乘客，将请求队列中到达时间最早的请求作为主请求
  - $(2)、$如果电梯中有乘客，将其中到达时间最早的乘客请求作为主请求

- $2、$被捎带请求选择规则：

  - $(1)、$电梯的主请求存在
  - $(2)、$该请求投喂的时刻**小于等于**电梯到达该请求出发楼层关门的截止时间
  - $(3)、$电梯的运行方向和该请求的目标方向一致

- $3、$在电梯的调度上，**本次作业**指定了完成乘客请求的电梯。**后续作业**同学们可以自行设计调度器将请求分配给合适的电梯。

  请同学们合理设计自己的捎带策略，保证自己的电梯**性能符合基本要求**，即程序运行时间$T\leq T_{max}$,$T_{max}$的定义见**公测数据限制**


### 五、数据限制

#### 一、数据基本限制

- 可输入电梯系统的指令数：**1~100条**（指令数为0或超过100均为不合法输入）。
- 乘客$ID$保证不重复，存在于电梯系统内的电梯$ID$保证不重复，所有$ID$均为int范围内正整数。
- 乘客请求中保证起点层和终点层不同
- 输入数据的时间戳精确到**小数点后一位**

#### 二、公测数据限制

- 标程运行时间$T_{std}$：课程组标程运行测试点所使用的时间。
- 公测中$T_{max}$与标程运行时间$T_{std}$的计算公式如下。

$$ T_{max} = \max\left(T_{std}+10, 1.15\times T_{std}\right) $$

- 包括强测在内的数据都会保证正常程序的电梯系统时间不会超过 $T_{max}$，也会**避免使用对边界情况较为敏感的数据**。
- **对于中测和强测数据，$T_{max}$ 将会严格限制为通过上述公式计算得到的值。**<del>所以，请不要试图用超长的 sleep 来回避线程安全停止的问题。</del>

#### 三、互测数据限制

- 系统时间上限 $T_{max}$：对于互测数据，$T_{max}$ 为120s。
- 第一条指令的投喂时间在1s或1s以后。
- 最后一条指令的输入时间不晚于50s。
- 指令条数不超过70。
- **同一部电梯最多有30条相关的乘客请求**。
- 随测试点提交的输出合法。

------

## 第五部分：样例

| 输入                                                         | 输出                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [9.6]1-FROM-4-TO-5-BY-1                                      | [  10.6380]ARRIVE-2-1<br/>[  11.0480]ARRIVE-3-1<br/>[  11.4540]ARRIVE-4-1<br/>[  11.4550]OPEN-4-1<br/>[  11.6610]IN-1-4-1<br/>[  11.8630]CLOSE-4-1<br/>[  12.2720]ARRIVE-5-1<br/>[  12.2730]OPEN-5-1<br/>[  12.2740]OUT-1-5-1<br/>[  12.6770]CLOSE-5-1 |
| [4.1]1-FROM-2-TO-9-BY-1<br/>[7.5]2-FROM-1-TO-10-BY-2         | [   5.0700]ARRIVE-2-1<br/>[   5.0710]OPEN-2-1<br/>[   5.2880]IN-1-2-1<br/>[   5.4860]CLOSE-2-1<br/>[   5.9010]ARRIVE-3-1<br/>[   6.3060]ARRIVE-4-1<br/>[   6.7190]ARRIVE-5-1<br/>[   7.1540]ARRIVE-6-1<br/>[   7.5670]ARRIVE-7-1<br/>[   7.9810]ARRIVE-8-1<br/>[   8.0500]OPEN-1-2<br/>[   8.2580]IN-2-1-2<br/>[   8.3950]ARRIVE-9-1<br/>[   8.4000]OPEN-9-1<br/>[   8.4010]OUT-1-9-1<br/>[   8.4650]CLOSE-1-2<br/>[   8.8080]CLOSE-9-1<br/>[   8.8860]ARRIVE-2-2<br/>[   9.3020]ARRIVE-3-2<br/>[   9.7120]ARRIVE-4-2<br/>[  10.1290]ARRIVE-5-2<br/>[  10.5370]ARRIVE-6-2<br/>[  10.9490]ARRIVE-7-2<br/>[  11.3530]ARRIVE-8-2<br/>[  11.7610]ARRIVE-9-2<br/>[  12.1690]ARRIVE-10-2<br/>[  12.1690]OPEN-10-2<br/>[  12.1720]OUT-2-10-2<br/>[  12.5950]CLOSE-10-2 |
| [1.9]2-FROM-10-TO-6-BY-1<br/>[6.6]1-FROM-3-TO-5-BY-2         | [   2.9360]ARRIVE-2-1<br/>[   3.3490]ARRIVE-3-1<br/>[   3.7610]ARRIVE-4-1<br/>[   4.1700]ARRIVE-5-1<br/>[   4.5750]ARRIVE-6-1<br/>[   4.9810]ARRIVE-7-1<br/>[   5.3970]ARRIVE-8-1<br/>[   5.8100]ARRIVE-9-1<br/>[   6.2230]ARRIVE-10-1<br/>[   6.2260]OPEN-10-1<br/>[   6.4330]IN-2-10-1<br/>[   6.6320]CLOSE-10-1<br/>[   7.0480]ARRIVE-9-1<br/>[   7.4580]ARRIVE-8-1<br/>[   7.6460]ARRIVE-2-2<br/>[   7.8670]ARRIVE-7-1<br/>[   8.0530]ARRIVE-3-2<br/>[   8.0530]OPEN-3-2<br/>[   8.2570]IN-1-3-2<br/>[   8.2770]ARRIVE-6-1<br/>[   8.2770]OPEN-6-1<br/>[   8.2780]OUT-2-6-1<br/>[   8.4570]CLOSE-3-2<br/>[   8.6920]CLOSE-6-1<br/>[   8.8750]ARRIVE-4-2<br/>[   9.2850]ARRIVE-5-2<br/>[   9.2850]OPEN-5-2<br/>[   9.2870]OUT-1-5-2<br/>[   9.6990]CLOSE-5-2 |
| [2.7]1-FROM-2-TO-8-BY-1<br/>[4.3]2-FROM-11-TO-3-BY-2<br/>[7.4]3-FROM-3-TO-8-BY-3 | [   3.7670]ARRIVE-2-1<br/>[   3.7680]OPEN-2-1<br/>[   3.9750]IN-1-2-1<br/>[   4.1780]CLOSE-2-1<br/>[   4.5910]ARRIVE-3-1<br/>[   5.0060]ARRIVE-4-1<br/>[   5.3560]ARRIVE-2-2<br/>[   5.4160]ARRIVE-5-1<br/>[   5.7640]ARRIVE-3-2<br/>[   5.8240]ARRIVE-6-1<br/>[   6.1730]ARRIVE-4-2<br/>[   6.2330]ARRIVE-7-1<br/>[   6.5790]ARRIVE-5-2<br/>[   6.6420]ARRIVE-8-1<br/>[   6.6430]OPEN-8-1<br/>[   6.6440]OUT-1-8-1<br/>[   7.0060]ARRIVE-6-2<br/>[   7.0520]CLOSE-8-1<br/>[   7.4140]ARRIVE-7-2<br/>[   7.8390]ARRIVE-8-2<br/>[   8.2810]ARRIVE-9-2<br/>[   8.4690]ARRIVE-2-3<br/>[   8.7000]ARRIVE-10-2<br/>[   8.8790]ARRIVE-3-3<br/>[   8.8820]OPEN-3-3<br/>[   9.0920]IN-3-3-3<br/>[   9.1190]ARRIVE-11-2<br/>[   9.1220]OPEN-11-2<br/>[   9.2920]CLOSE-3-3<br/>[   9.3390]IN-2-11-2<br/>[   9.5280]CLOSE-11-2<br/>[   9.7090]ARRIVE-4-3<br/>[   9.9480]ARRIVE-10-2<br/>[  10.1180]ARRIVE-5-3<br/>[  10.3530]ARRIVE-9-2<br/>[  10.5250]ARRIVE-6-3<br/>[  10.7600]ARRIVE-8-2<br/>[  10.9270]ARRIVE-7-3<br/>[  11.1780]ARRIVE-7-2<br/>[  11.3320]ARRIVE-8-3<br/>[  11.3340]OPEN-8-3<br/>[  11.3410]OUT-3-8-3<br/>[  11.5850]ARRIVE-6-2<br/>[  11.7410]CLOSE-8-3<br/>[  11.9970]ARRIVE-5-2<br/>[  12.3980]ARRIVE-4-2<br/>[  12.8090]ARRIVE-3-2<br/>[  12.8100]OPEN-3-2<br/>[  12.8100]OUT-2-3-2<br/>[  13.2240]CLOSE-3-2 |

## 第六部分：性能分说明


​	**本次作业功能分为85分，性能分为15分，二者之和为总分。**在强测时，性能分将由三部分组成：系统运行时间，等待时间与期望时间之差的最大值和系统耗电量。其中，系统运行时间即为$T_{run}=\max\\{T_{real},T_{final}\\}$。最大等待时间与期望时间之差计算方法如下。

​	对第$i$个请求，设其等待时间为$T_{i}=T_{到达目标楼层}-T_{发出请求}$，该请求的期望等待时间$ET_i$计算公式如下。
$$
ET_i=\frac{\sum_{f=F_{min}}^{F_{max}}|F_s-f|T_{move}}{F_{max}-F_{min}+1}+T_{open}+T_{close}+|F_d-F_s|T_{move}\\\
F_{min}:电梯系统最低楼层\\\
F_{max}:电梯系统最高楼层\\\
F_s:请求的起始楼层\\\
F_d:请求的目标楼层\\\
T_{open}:开门时间\\\
T_{close}:关门时间\\\
T_{move}:电梯移动时间\\\
$$
​	本次作业，上述公式中为定值的参数如下。
$$
F_{min}=1\\\
F_{max}=11\\\
T_{open}=0.2\\\
T_{close}=0.2\\\
T_{move}=0.4
$$
​	整个公式中，后三个数是电梯将该乘客送往目的楼层的所需时间，第一个项是在假设电梯在各楼层的概率分布为均匀分布时电梯到达起始楼层的期望。则等待时间与期望时间之差的最大值为
$$
MT=\max_i (T_{i}-ET_i)
$$
​	系统耗电量将使用以下方法计算。

​	根据输出信息中的`ARRIVE, OPEN, CLOSE`信息的数量进行计算。

- 每条`ARRIVE`信息表示电梯移动一层，耗电量$W_{ARRIVE}=0.4$
- 每条`OPEN(CLOSE)`信息表示电梯开门（关门）一次，耗电量$W_{OPEN}=W_{CLOSE}=0.1$
- 系统的耗电量$W=W_{OPEN}N_{OPEN}+W_{CLOSE}N_{CLOSE}+W_{ARRIVE}N_{ARRIVE}$，其中$N_{OPEN},N_{CLOSE},N_{ARRIVE}$分别表示输出中$OPEN,CLOSE,ARRIVE$信息的总数。

​	设对于所有同学的数据，参数$x$的平均值为$x_{avg}$，最大值为$x_{max}$，最小值为$x_{min}$，则定义以下折算函数
$$
base_{min}=p\cdot x_{avg} + (1-p) \cdot x_{min}\\
base_{max}=p\cdot x_{avg} + (1-p) \cdot x_{max}\\
p=0.25\\
r(x)= 100 \% \cdot\begin{cases}1 & x \leq base_{min} \\1-10^{1-\frac{base_{max}-base_{min}}{x-base_{min}}} & base_{min} < x \leq base_{max} \\\ 0 & x > base_{max}\end{cases}\\
$$
​	最终性能分$s$将由以下公式计算。
$$
s=15\times(0.3r(T_{run})+0.3r(MT)+0.4r(W))
$$
​	其中$T_{run},MT,W$为你的程序的运行时间，等待时间与期望时间之差的最大值和系统耗电量。

性能分公式可能比较复杂，但实际上公式表达出的意思就是希望你的程序**在保证正确性的前提下**能够尽量做到以下三点。

- 运行时间尽量短
- 尽量不让请求等待过长时间
- 尽量减少系统的无效运行

---


## 第七部分：说明与警示

- 1、**代码实现中不存在轮询**。轮询是一种非常占用 CPU 资源的行为，为了避免出现轮询的情况，**请使用 Wait-Notify 的方式编程**。同时，为了检查是否出现轮询的情况，总 CPU 时间限制为 10s，不满足该限制的程序会被判定为错误。

- $ 2、$关于接口的一些使用，可以在 idea 里面，按 Ctrl+Q 。将可以看到类和方法的使用格式以及注释（本次官方提供的接口均提供了中文版 javadoc 注释，Ctrl+Q 可以直接查看）

- $ 3、$请**在代码一开始就初始化时间戳**，否则可能会出现和评测不一致的情况。

  ```java
  import com.oocourse.elevator1.TimableOutput;
  
  public class MainClass {
    public static void main(String[] args) {
      TimableOutput.initStartTimestamp();  // 初始化时间戳
  		/*
  			代码部分
  		*/
    }
  }
  ```

- $ 4、$官方提供的输出包是**线程安全**的，同学们无需对其进行同步控制。

- $ 5、$由于**多线程调度存在随机性**，在使用官方提供的投喂脚本或进行互测环节时，可能会出现**输出与官方评测机不一致、bug 无法复现的情况**，最终结果均**以官方评测机为准**。
- $ 6、$**基于行断点机制的调试会对程序的运行行为产生较大影响，应谨慎使用**。
### 警示

<font color = red>不要试图Hack评测机，不要抄袭。如发现其他人的代码疑似存在上述行为，可向课程组举报。课程组感谢同学们为课程建设所作出的贡献。</font>

